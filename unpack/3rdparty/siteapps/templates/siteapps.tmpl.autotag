[% FOREACH page = return_ %]

<!DOCTYPE html>
<html>
    <head>
        <title>cPanel</title>
        <meta name="viewport" content="width=device-width, initial-scale=1.0">
        <link rel="stylesheet" type="text/css" href="siteapps.css">
        <link href='https://fonts.googleapis.com/css?family=Open+Sans:400,600,700' rel='stylesheet' type='text/css'>
        <script src="https://code.jquery.com/jquery.js"></script>

        <!-- the YUI dialog had nasty border artifacts; not sure what they were trying to accomplish, but it wasn't working; turning that stuff off -->
        <style>
            .yui-panel .bd, .panel .bd { border-width: 0px 0px 0px; }
            .yui-panel .ft, .panel .ft { border-width: 0px; }
        </style>

        <!-- the YUI dialog close button works the first time but not the second time the dialog pops up; and what the heck is going on with one "x" replacing the other on hoover? -->
        <style>
        .yui-panel .container-close {
            display: none;
        }
        </style>

        <!-- instead, try to style the Cancel button we create to look like the close button did -->
<!-- XXXX fix the magic_revision stuff -->
        <style>
.button-group button#cancel_button {
    background: url("/cPanel_magic_revision_1352841119/yui/container/assets/close12_1.gif") no-repeat scroll 0 0 transparent;
    cursor: pointer;
    height: 14px;
    width: 14px;
    margin: 0;
    overflow: hidden;
    padding: 0;
    position: absolute;
    text-decoration: none;
    text-indent: -10000em;
    top: 5px;
    visibility: inherit;
    z-index: 6;
    left: 4px;
    color: #014D5F;
    border-collapse: separate;
    font: 7px Arial;
}
        </style>
    </head>
    <body class="yui-skin-sam">

[% IF page.error %]

    <p><b>This feature may not be available due to lack of installed credentials.  Please contact your hosting provider to have this feature enabled.</b></p>

    Error: [% page.error %]

[% ELSE %]
<script>
jQuery(function() {

   jQuery.each(jQuery(".sa_on_off"), function(e) {
      jQuery(this).html('<span><i class="sa_on_off_item_' + jQuery(this).attr("data-current-state") + '"></i></span>');
   });

   jQuery('.sa_on_off').on('turn_on', function(eve, cb) {

      var o = jQuery("i", jQuery(this));
      if (!jQuery(o).hasClass('sa_on_off_item_off'))
         return;

      jQuery(o).animate({"left": "-=39px"}, "slow");
      jQuery(o).removeClass('sa_on_off_item_off');
      jQuery(o).addClass('sa_on_off_item_on');
      jQuery(this).attr("data-current-state", "on");

      if (typeof cb !== 'undefined') {
         cb(jQuery(this));
      }

   });

   jQuery('.sa_on_off').on('turn_off', function(eve, cb) {

      var o = jQuery("i", jQuery(this));
      if (!jQuery(o).hasClass('sa_on_off_item_on'))
         return;

      jQuery(o).animate({"left": "+=39px"}, "slow");
      jQuery(o).removeClass('sa_on_off_item_on');
      jQuery(o).addClass('sa_on_off_item_off');
      jQuery(this).attr("data-current-state", "off");

      if (typeof cb !== 'undefined') {
         cb(jQuery(this));
      }

   });

   jQuery('.sa_on_off').on('run', function(eve) {
      var o = jQuery("i", jQuery(this));
      if (jQuery(o).hasClass('sa_on_off_item_off')) {
         if (typeof eve.turn_on !== 'undefined') {
            jQuery(this).trigger("turn_on", eve.turn_on);
         }
      } else {
         if (jQuery(o).hasClass('sa_on_off_item_on')) {
            if (typeof eve.turn_off !== 'undefined') {
               jQuery(this).trigger("turn_off", eve.turn_off);
            }
         }
      }
   });

});
</script>

      <script>
        final_query_string=window.location.search.replace('?', '&');
        final_query_string += '&plugin_version=[% page.plugin_version %]';
        jQuery(function() {
            jQuery(".sa_on_off").on('click', function() {
               var event = jQuery.Event("run");
               event.turn_on = function(obj) {
    			CPANEL.api( {
        		module:   "Siteapps",
        		func:     "insertTag",
        		data:     { site_id: obj.attr("data-site-id"), site_url: obj.attr("data-site-url") },   
    			} );
            	saved_notice = new CPANEL.ajax.Dynamic_Notice( {
                level: "warning",
                content: "Tag Status updated: Turned ON.<br><br> Changes take about 1 minute to be applied.",
                replaces: saved_notice } );
            } ;
               event.turn_off = function(obj) {
    			CPANEL.api( {
        		module:   "Siteapps",
        		func:     "removeTag",
        		data:     { site_id: obj.attr("data-site-id"), site_url: obj.attr("data-site-url") },   
    			} );
            	saved_notice = new CPANEL.ajax.Dynamic_Notice( {
                level: "warning",
                content: "Tag Status updated: Turned OFF.<br><br> Changes take about 1 minute to be applied.",
                replaces: saved_notice } );
 
               };
               jQuery(this).trigger(event);
            });
         });
      </script>


        <div>
            <form id="redirect" method="POST">
                <input type="hidden" name="token"/>
            </form>
        </div>

        <div id="saWrap">
            <h1 id="saLogo">SiteApps</h1>
            <iframe id="iframe1" class="saSuperBanner" src=""></iframe>
            <script>
              document.getElementById("iframe1").src = "https://api.siteapps.com/hosting/cpanel_box?public-key=[% page.public_key %]&hash=[% page.null_message_hash %]" + final_query_string;
            </script>
            <div class="saInfoBar clearfix">
                <div class="saInfoResult"><strong>[% page.num_results %]</strong> results</div>
                <div class="saInfoPagination">


                    [% IF page.prev_page_num %]
                    <div class="saPrev">
                        <a href="?page=[% page.prev_page_num %]">
                            <span class="saPrevArrow"></span>Prev
                        </a>
                    </div>
                    [% END %]

                    <div class="saPaginationNumbers">
                        <ul>

                        [% pagenum = 1 %]
                        [% WHILE pagenum < page.num_pages %]
                            [% IF pagenum == page.current_page_num %]
                              <!--  <li class="saNumberActive">[% pagenum %]</li> -->
                            [% ELSE %]
                              <!--  <li><a href="?page=[% pagenum %]">[% pagenum %]</a></li> -->
                            [% END %]
                        [% SET pagenum = pagenum + 1 %]
                        [% END %]

                        </ul>
                    </div>

                    [% IF page.next_page_num %]
                    <div class="saNext">
                        <a href="?page=[% page.next_page_num %]">
                            <span class="saNextArrow"></span>Next
                        </a>
                    </div>
                    [% END %]

                </div>
            </div>

    <!--  handle "Get Started" button -->

<script type="text/javascript">

var saved_notice = null;

function plan_button(button, site_id ) {

    CPANEL.api( {
        module:   "Siteapps",
        func:     "createLoginToken",
        data:     { site_id: site_id  },
        callback: CPANEL.ajax.build_callback( function(response) {
            var cpanel_data = response.cpanel_data[0];  // contains success, token, and url_to_login
            if( cpanel_data["success"] ) {
                // console.log( response ); 
                $('form#redirect').attr('action', cpanel_data.url_to_login+'?');
                $('form#redirect input[name=token]').val( cpanel_data.token );
                $('form#redirect input[name=partial_url]').val('/Plan/edit');
                $('form#redirect').submit();
            } else {
                alert("Unexpected failure in createLoginToken: " + cpanel_data["error"]);
            }
        } )
    } );

}


function green_button( button, site_id ) {

    CPANEL.api( {
        module:   "Siteapps",
        func:     "createLoginToken",
        data:     { site_id: site_id  },
        callback: CPANEL.ajax.build_callback( function(response) {
            var cpanel_data = response.cpanel_data[0];  // contains success, token, and url_to_login
            if( cpanel_data["success"] ) {
                // console.log( response ); 
                $('form#redirect').attr('action', cpanel_data.url_to_login);
                $('form#redirect input[name=token]').val( cpanel_data.token );
                $('form#redirect').submit();
            } else {
                alert("Unexpected failure in createLoginToken: " + cpanel_data["error"]);
            }
        } )
    } );

}

function orange_button( button, domain_name ) {
    
    button.removeAttr('onclick');   // remove the onclick="javascript:orange_button(...)" that invokes this
    button.text('');
    var newImg = document.createElement("img");
    newImg.src = "siteapps_loading.gif";
    button.append(newImg);
    if (saved_notice && !DOM.inDocument(saved_notice.element)) {
        saved_notice = null;
    }

    var success = function(response) {
        // console.log(response);
        var cpanel_data = response.cpanel_data[0];  // contains plan_name, site_id, success (hopefully)
        if( cpanel_data["success"] ) {
            saved_notice = new CPANEL.ajax.Dynamic_Notice( {
                level: "success",
                content: "SiteApps activated for " + domain_name + ". Accessing Dashboard...",
                replaces: saved_notice
            } );
            button.removeClass('orangeBtn');
            button.addClass('greenBtn');
            // button.attr( 'href', 'siteapps_redirect.live.cgi?site_id=' + cpanel_data.site_id ); 
            // button.attr( 'target', '_blank' ); // XXX
            button.removeAttr('onclick');   // remove the onclick="javascript:orange_button(...)" that invokes this
            button.text( 'Access SiteApps Dashboard' );
            button.prev().html('<p style="font-weight: bold;">Plan: <span style="border-right: 1px solid #c1c1c1;color:#ea5a11;padding-right: 9px;margin-right: 9px;">[% domain.plan_name %]</span> Tag status: <span id="on_off_'+cpanel_data.site_id+'" data-site-url="'+domain_name+'" data-site-id="'+cpanel_data.site_id+'" class="sa_on_off" data-current-state="on"></span>&nbsp;&nbsp; </p>');
            //location.reload();
            button.click( function() { green_button( $(this), cpanel_data.site_id ) } );
	    green_button( $(this), cpanel_data.site_id );
        } else {
            if( cpanel_data.error_code && cpanel_data.error_code == 1296525 ) {
                ask_the_user_for_his_or_her_email_address( button, domain_name );
            } else {
                alert(cpanel_data["error"]);
                button.click( function() { orange_button( $(this), domain_name ) } );
                button.text('Get Started with SiteApps Now');
                location.reload();
            }
        }
              
    };
   
    CPANEL.api( {
        module:   "Siteapps",
        func:     "createSite",
        data:     { plan_id: [% page.free_plan_id %], site_url: domain_name },
        callback: CPANEL.ajax.build_callback( success, null )
    } );

}
 
function ask_the_user_for_his_or_her_email_address( button, domain_name ) {

    // alert("ask the user for his or her email address running");

    $('#prompt_email').css( 'display', 'block' ); // unhide the content

    var popup = new YAHOO.widget.SimpleDialog("prompt_email", { 
        width: "20em", 
        effect:{
            effect: YAHOO.widget.ContainerEffect.FADE,
            duration: 0.25
        }, 
        fixedcenter: true,
        modal: true,
        visible: false,
        draggable: false,
       	buttons: [ 
            {
                text: "Cancel", 
                // id:   "cancel_button", // nope, per http://developer.yahoo.com/yui/docs/YAHOO.widget.Dialog.html#config_buttons, only text and handler fields are supported.  do this below with jquery.
                handler: function () {
                    this.hide();
                } 
            },
            {
            text: "Set Email Address", handler: function () {

                var email = $('form#email_address input[name=email]').val();
                var popup = this;

                var success = function(response) {
                    console.log(response);
                    popup.hide();
                    if( response.error ) {
                        alert( response.error );
                    } else {
                        var cpanel_data = response.cpanel_data[0];
                        orange_button( button, domain_name );  // go try again
                    }
                }
 
                CPANEL.api( {
                    module:   'CustInfo',
                    func:     'savecontactinfo',
                    data:     { email: email },   
                    callback: CPANEL.ajax.build_callback( success, null )
                } );

                this.hide();
            }
        } ]
    });

    popup.render(document.body);
    popup.show();

    // terrible kludge to change our Cancel button into a little X since YUI is so hopelessly lame
    $("button:contains('Cancel')").attr( 'id', 'cancel_button' );
 
}

</script>

    <!-- pop-up for prompting users for their email address

    <!-- <div id="prompt_email" style="padding: 15px;" style="display: none;"> -->
    <div id="prompt_email" style="padding: 15px; z-index: -1; display: none; ">
        <br>
        Enabling SiteApps for your domain requires an email address, but
        there isn't currently one in your cPanel profile.
        This email address will be used to log in to the SiteApps portal.
        <br><br>
        <form id="email_address">
            Please enter your email address: <input type="text" name="email">
        </form>
    </div>

    <div id="saTermsOfService">
        By clicking <strong>'Get Started with SiteApps'</strong>, you agree with
        <a href="https://siteapps.com/site/terms/1" target="_blank">Terms of Use</a> and <a href="https://siteapps.com/site/terms/2" target="_blank">End User License Agreement</a>
    </div>

    <!-- start domains list -->
    <div id="saContent" class="clearfix">
        <ul>
    [% FOREACH domain = page.domains %]
        <li>
                        <div class="saLeftContent">
                            <h3>[% domain.name %]</h3>

                                [% IF domain.is_a_siteapps_domain %]
                                	[% IF domain.autotag_on %]
                                		<div class="tag_status"><p style="font-weight: bold;">Plan: <a title="Change your plan" href="#" onclick="javascript:plan_button($(this), [% domain.site_id %] );"><span style="border-right: 1px solid #c1c1c1;color:#ea5a11;padding-right: 9px;margin-right: 9px;">[% domain.plan_name %]</span></a> Tag status: <span id="on_off_[% domain.site_id %]" data-site-url="[% domain.name %]" data-site-id="[% domain.site_id %]" class="sa_on_off" data-current-state="on"></span>&nbsp;&nbsp; </p></div>
                                	[% ELSE %]
                                		<div class="tag_status"><p style="font-weight: bold;">Plan: <a title="Change your plan" href="#" onclick="javascript:plan_button($(this), [% domain.site_id %] );"><span style="border-right: 1px solid #c1c1c1;color:#ea5a11;padding-right: 9px;margin-right: 9px;">[% domain.plan_name %]</span></a> Tag status: <span id="on_off_[% domain.site_id %]" data-site-url="[% domain.name %]" data-site-id="[% domain.site_id %]" class="sa_on_off" data-current-state="off"></span>&nbsp;&nbsp; </p></div>
                                	[% END %]
                                	<a class="greenBtn" onclick="javascript:green_button($(this), [% domain.site_id %] );" >Access SiteApps Dashboard</a>
                                [% ELSE %]
                                	<a class="orangeBtn" onclick="javascript:orange_button($(this), '[% domain.name %]'); return false;">Get Started with SiteApps Now</a>
                                
                                [% END %]
                        </div>
                        <div float="right">
                                <iframe id="iframe_[% domain.name %]" class="saRightContent" src=""></iframe>
                            [% IF domain.site_id %]
                                <script>
                                  document.getElementById("iframe_[% domain.name %]").src = "https://api.siteapps.com/hosting/cpanel_box_domain?[% domain.iframe_query_string %]"+final_query_string+"&site_id=[% domain.site_id %]";
                                </script>
                            [% ELSE %]
                              <script>
                                document.getElementById("iframe_[% domain.name %]").src = "https://api.siteapps.com/hosting/cpanel_box_domain?public-key=[% page.public_key %]&hash=[% page.null_message_hash %]" + final_query_string;
                              </script>
                            [% END %]
                        </div>
        </li>
    [% END %]
        </ul>
    </div>
    <!-- end domains list -->

         <div class="saInfoBarBottom clearfix">

                <! -- nav same as above -->
                <div class="saInfoPagination">
                    [% IF page.prev_page_num %]
                    <div class="saPrev">
                        <a href="?page=[% page.prev_page_num %]">
                            <span class="saPrevArrow"></span>Prev
                        </a>
                    </div>
                    [% END %]

                    <div class="saPaginationNumbers">
                        <ul>

                        [% pagenum = 1 %]
                        [% WHILE pagenum < page.num_pages %]
                            [% IF pagenum == page.current_page_num %]
                               <!--  <li class="saNumberActive">[% pagenum %]</li> -->
                            [% ELSE %]
                               <!-- <li><a href="?page=[% pagenum %]">[% pagenum %]</a></li> -->
                            [% END %]
                        [% SET pagenum = pagenum + 1 %]
                        [% END %]

                        </ul>
                    </div>

                    [% IF page.next_page_num %]
                    <div class="saNext">
                        <a href="?page=[% page.next_page_num %]">
                            <span class="saNextArrow"></span>Next
                        </a>
                    </div>
                    [% END %]
                </div>

            </div>
        </div>

[% END %]  <!-- endif page.error -->

    </body>
</html>

[%END %] <!-- end forpage page = _return -->

